(()=>{var lt=Object.defineProperty;var c=(W,p)=>lt(W,"name",{value:p,configurable:!0});(window.webpackJsonp=window.webpackJsonp||[]).push([["gantry-v2-async-client-boot-apis"],{CTVb:function(W,p,r){"use strict";r.r(p),r.d(p,"register",function(){return N}),r.d(p,"test",function(){return J});var d=r("9oTK"),b=r("ifKl"),j=r("Lgge"),A=r("Xm7Q"),y=r("s4P+"),P=r("cznn"),R=r("Ki/W");function E(e){if(!e)return{};const t=e.history.messages,a=e.channel||e.group||e.im,o=a==null?void 0:a.id,i=e.history.channel_actions_count,s=Number.isInteger(i)?{channelId:o,count:i}:null;return{channelData:a,messagesData:{msgs:t,channelId:o,latest:t.length>0?t[0].ts:null,oldest:t.length>0?t[t.length-1].ts:null,hasMore:{hasMoreEnd:!1,hasMoreStart:e.history.has_more},isLimited:e.history.is_limited},membersData:e.users,botsData:e.bots,channelActionsData:s,mutationTimestampsData:e.history.mutation_timestamps}}c(E,"processMessagesData");var M=r("Omjo"),K=r("Pw4T"),B=r("KGIc");function Y(e){let{featureFlagConfigVersionTs:t,experimentsConfigVersionTs:a,teamId:o}=e;t||Object(K.a)().count("mvb_missing_feature_flag_config_version"),a||Object(K.a)().count("mvb_missing_experiment_config_version"),Object(M.b)("BOOT",`Feature flag config version: ${t}; Experiments config version: ${a}`),Object(B.i)(o,Math.min(a,t));const i=Object(B.c)();i?Object(M.b)("BOOT",`Current earliest config version: ${i}; All config versions: ${Object(B.a)()}`):Object(y.b)().warn("BOOT",`Missing config version: ${i}; All config versions: ${Object(B.a)()}`)}c(Y,"storeConfigVersion");var I=r("heB0");function X(e){return C.apply(this,arguments)}c(X,"maybeFetchAllOnboardingData");function C(){return C=Object(d.coroutine)(function*(e){let{apiData:t,contextualInfo:a}=e;const o={onboardingData:null,labFeaturesStartupData:null},{featureFlagData:i}=t,s=t.clientBootData;if(!s||!i)return o;const{userPrefsData:u}=s,l=!!(i!=null&&i.feature_composer_email_classification);var m;if(!((m=window.location.search.match("skip_onboarding"))!==null&&m!==void 0?m:!1)&&u&&!u.onboarding_complete){var h;o.onboardingData=yield Object(I.k)(a),!((h=o.onboardingData)===null||h===void 0)&&h.setup_started||l&&(o.labFeaturesStartupData=yield Object(I.j)(a))}return o}),C.apply(this,arguments)}c(C,"_maybeFetchAllOnboardingData");function Z(e){let{viewData:t,channelsData:a=[]}=e;if(!(t!=null&&t.channelData))return a;const o=a.findIndex(i=>{var s;return i&&i.id===(t==null||(s=t.channelData)===null||s===void 0?void 0:s.id)});if(o!==-1){const i={...a[o],...t.channelData};a.splice(o,1,i)}return a}c(Z,"maybeMergeKnownChannelsData");var L=r("mard"),w=r("60mp");function k(e){return F.apply(this,arguments)}c(k,"maybeReloadForReAuth");function F(){return F=Object(d.coroutine)(function*(e){let{clientBootData:t}=e;if(!(t==null?void 0:t.should_reauth))return;Object(M.b)("BOOT","Detected need to reauth; fetching auth and halting current boot.");const o=!1,i=!1,s=[],u=!0;return Object(w.d)(o,i,s,u),Object(L.a)()}),F.apply(this,arguments)}c(F,"_maybeReloadForReAuth");var n=r("wwBm"),f=r("qiCS"),g=r("kBpe"),v=r("gW03");function V(e){return D.apply(this,arguments)}c(V,"maybeRedirectToTermsOfService");function D(){return D=Object(d.coroutine)(function*(e){let{clientBootData:t}=e;var a;const o=t.acceptTosUrl;if(!o)return;const i=t==null||(a=t.teamData)===null||a===void 0?void 0:a.url;if(Object(g.i)()){const m=`${i}ssb/redirect`,T=Object(f.d)(o,"redirect",m),h=new v.a("User needs to accept Custom TOS");throw h.type=A.a.API,h.subType="custom_tos",h.data={error:"user_needs_to_accept_custom_tos",url:T},h}const s=Object(n.f)(location.search,"force_cold_boot",1),u=`${i}gantry${location.pathname}${s}`,l=Object(f.d)(o,"redirect",u);return Object(M.b)("BOOT",`(${t.teamData.id}) User needs to accept the terms of service; redirecting to ${l}`),location.assign(l),Object(L.a)()}),D.apply(this,arguments)}c(D,"_maybeRedirectToTermsOfService");var _=r("ycWl"),O=r("31wZ");function $(e){return S.apply(this,arguments)}c($,"maybeReloadForMinVersionBump");function S(){return S=Object(d.coroutine)(function*(e){let{clientBootData:t}=e;const{should_reload:a,client_min_version:o}=t,i=Object(B.d)();if(parseInt(i??"0",10)&&a){if(Object(O.a)(o))return Object(_.a)({reason:"Reloading due to a min version bump (client.boot)",reasonKey:"min_version_bump_client_boot"}),Object(L.a)();throw new Error("Unable to reload for min version bump at boot")}}),S.apply(this,arguments)}c(S,"_maybeReloadForMinVersionBump");function U(e){return x.apply(this,arguments)}c(U,"transformInitialApiResponses");function x(){return x=Object(d.coroutine)(function*(e){let{apiCalls:t,contextualInfo:a}=e;const{clientBootData:o,viewData:i,...s}=t,u=t.clientBootData.then(R.a);u.catch(b.a);const l=t.viewData.then(E);return l.catch(b.a),{apiCalls:{clientBootData:u,viewData:l,...s},contextualInfo:a}}),x.apply(this,arguments)}c(x,"_transformInitialApiResponses");function q(e){return G.apply(this,arguments)}c(q,"setConfigVersions");function G(){return G=Object(d.coroutine)(function*(e){let{apiCalls:t,contextualInfo:a}=e;const{teamId:o}=a;if(!o)return{apiCalls:t,contextualInfo:a};const{featureFlagData:i,experimentData:s}=t;return j.a.all([i,s]).then(u=>{let[l,m]=u;const{config_version_ts:T}=l,{config_version_ts:h}=m;Y({featureFlagConfigVersionTs:T,experimentsConfigVersionTs:h,teamId:o})},()=>{}).catch(u=>{Object(y.b)().error("BOOT",`Failed to store config version: ${u}`)}),{apiCalls:t,contextualInfo:a}}),G.apply(this,arguments)}c(G,"_setConfigVersions");function et(e){return Q.apply(this,arguments)}c(et,"startOnboardingApis");function Q(){return Q=Object(d.coroutine)(function*(e){let{apiCalls:t,contextualInfo:a}=e;const{getTracer:o,getTrace:i}=a.getTraceMeta(),s=i(),u=j.a.all([t.clientBootData,t.featureFlagData]).then(l=>{let[m,T]=l;return o().traceFn({name:"fetchOnboardingData",options:{traceId:s.getTraceId(),parentSpanId:s.getRootSpanId()}},X.bind(null,{apiData:{clientBootData:m,featureFlagData:T},contextualInfo:a}))}).catch(l=>{throw l.type=A.a.API,l.subType="allOnboardingData",l});return u.catch(b.a),{apiCalls:{allOnboardingData:u,...t},contextualInfo:a}}),Q.apply(this,arguments)}c(Q,"_startOnboardingApis");function tt(e){return H.apply(this,arguments)}c(tt,"maybeMergeChannelData");function H(){return H=Object(d.coroutine)(function*(e){let{apiCalls:t,contextualInfo:a}=e;const o=j.a.all([t.clientBootData,t.viewData]).then(i=>{let[s,u]=i;return{...s,channelsData:Z({viewData:u,channelsData:s.channelsData})}});return o.catch(b.a),{apiCalls:{...t,clientBootData:o},contextualInfo:a}}),H.apply(this,arguments)}c(H,"_maybeMergeChannelData");function N(e){e.hooks.apiAfterInitialCalls.tap("Transform initial API responses",U),e.hooks.apiAfterInitialCalls.tap("Maybe reload for a min version bump based on the client.boot response",function(){var t=Object(d.coroutine)(function*(a){let{apiCalls:o,contextualInfo:i}=a;const s=o.clientBootData.then(function(){var u=Object(d.coroutine)(function*(l){return yield $({clientBootData:l}),l});return function(l){return u.apply(this,arguments)}}());return s.catch(b.a),{apiCalls:{...o,clientBootData:s},contextualInfo:i}});return function(a){return t.apply(this,arguments)}}()),e.hooks.apiAfterInitialCalls.tap("Store config versions",q),e.hooks.apiAfterInitialCalls.tap("Start onboarding APIs",et),e.hooks.apiAfterInitialCalls.tap("Merge view data with client.boot channels data",tt),e.hooks.apiAfterInitialCalls.tap("Close API Boot Queue",P.a),e.hooks.apiAfterInitialCalls.tap("Maybe re-auth based on the client.boot response",function(){var t=Object(d.coroutine)(function*(a){let{apiCalls:o,contextualInfo:i}=a;const s=o.clientBootData.then(function(){var u=Object(d.coroutine)(function*(l){return yield k({clientBootData:l}),l});return function(l){return u.apply(this,arguments)}}());return s.catch(b.a),{apiCalls:{...o,clientBootData:s},contextualInfo:i}});return function(a){return t.apply(this,arguments)}}()),e.hooks.apiAfterInitialCalls.tap("Maybe redirect to the terms of service based on the client.boot response",function(){var t=Object(d.coroutine)(function*(a){let{apiCalls:o,contextualInfo:i}=a;const s=o.clientBootData.then(function(){var u=Object(d.coroutine)(function*(l){return yield V({clientBootData:l}),l});return function(l){return u.apply(this,arguments)}}());return s.catch(b.a),{apiCalls:{...o,clientBootData:s},contextualInfo:i}});return function(a){return t.apply(this,arguments)}}())}c(N,"register");const J={};Object.defineProperty(J,"transformInitialApiResponses",{get:()=>U,set:e=>{U=e}})},"Ki/W":function(W,p,r){"use strict";r.d(p,"a",function(){return I});var d=r("3Hq1"),b=r("owWc"),j=r("j77i"),A=r("dSGR"),y=r("T3x2"),P=r("YkFH"),R=r("1Np4"),E=r("hgl+");function M(n){return!!(n&&n.is_im)}c(M,"isIm");function K(n){return!!(n&&n.is_mpim)}c(K,"isMpim");function B(n){return M(n)&&n.user}c(B,"getMemberIdFromIm");function Y(n){return K(n)&&n.members}c(Y,"getMemberIdsFromMpim");function I(n){const f={};if(!Z(n))return L(n)?(f.should_reload=n.should_reload,f.client_min_version=n.client_min_version,f):(w(n)&&(f.should_reauth=n.should_reauth),f);const g=n,{team:v,links:V,subteams:D,self:_,prefs:O,app_homes:$,starred:S,read_only_channels:U,thread_only_channels:x,paid_features:q,emoji_cache_ts:G,commands_cache_ts:et,app_commands_cache_ts:Q,can_manage_shared_channels:tt,accept_tos_url:H,should_reload:N,client_min_version:J,is_europe:e,channels_priority:t,unchanged_channel_ids:a,hidden_messages_count:o,...i}=g,s=Object(R.a)({teamId:v.id,userId:_.id});Object(y.a)({data:n,tracer:s,fetchType:P.b.ClientBootGeneric}),f.hidden_messages_count=o;let u,l,m;if(k(n)&&(u=n.account_types,l=n.workspaces,m=n.default_workspace),n.auth_min_last_fetched&&E.a.maybeSetMinLastFetchedAuthTimestamp(n.auth_min_last_fetched),n.can_access_client_v2&&Object(j.u)(A.a,n.can_access_client_v2),!Object(d.a)(N)&&(f.should_reload=N,f.client_min_version=J,N))return f;const T={...v.prefs,can_user_manage_shared_channels:tt};var h;const nt=[...(h=D==null?void 0:D.self)!==null&&h!==void 0?h:[]],at=X({...i,teamId:v.id,starred:S,channels_priority:t,read_only_channels:U,thread_only_channels:x}),ot=(g.ims||[]).map(z=>B(z)).filter(z=>!!z),it=C(g.mpims),rt=ot.concat(it).filter((z,st,ct)=>ct.indexOf(z)===st);return{...f,selfData:_,teamData:v,teamPrefsData:T,userPrefsData:O,channelsData:at,starredChannels:S,readOnlyChannels:U,threadOnlyChannels:x,appHomesData:$,membersToFetch:rt,userGroupMembershipData:nt,paidFeatures:q,emojiBootData:{cacheTs:G},appCommandsCacheTs:Q,acceptTosUrl:H,isEurope:e,domainsBootData:V,accountTypes:u,workspaces:l,defaultWorkspace:m,channelsPriorityData:t,unchangedChannelIds:a}}c(I,"processClientBootData");function X(n){const f=[...n.channels||[],...n.ims||[],...n.mpims||[]],g=[];if(f.length){const{is_open:v=[]}=n,V=new Set(v),D=f.length;for(let _=0;_<D;_++){const O=f[_],$=O.id;O.is_member=!0,delete O.latest,delete O.last_read,(M(f[_])||K(f[_]))&&(O.is_open=V.has($)),g.push(O)}}return g}c(X,"hydrateChannelData");function C(n){return n?Object(b.a)(n,(f,g)=>{if(!g)return f;const v=Y(g)||[];return f.push(...v),f},[]):[]}c(C,"getMpimMembersFromMpims");function Z(n){return!Object(d.a)(n.team)}c(Z,"isPrimaryResponse");function L(n){return!Object(d.a)(n.should_reload)}c(L,"isShouldReloadResponse");function w(n){return!Object(d.a)(n.should_reauth)}c(w,"isShouldReauthResponse");function k(n){return!Object(d.a)(n.account_types)}c(k,"isClientUserBootResponse");const F={processClientBootData:I,getMpimMembersFromMpims:C};Object.defineProperty(F,"processClientBootData",{get:()=>I,set:n=>{I=n}}),Object.defineProperty(F,"getMpimMembersFromMpims",{get:()=>C,set:n=>{C=n}})},cznn:function(W,p,r){"use strict";r.d(p,"a",function(){return A});var d=r("9oTK"),b=r.n(d),j=r("Lgge");function A(P){return y.apply(this,arguments)}c(A,"apiCloseBootQueue");function y(){return y=Object(d.coroutine)(function*(P){let{apiCalls:R,contextualInfo:E}=P;return j.a.all(Object.values(R)).catch(()=>{}).finally(()=>{E.bootQueue.stop()}),{apiCalls:R,contextualInfo:E}}),y.apply(this,arguments)}c(y,"_apiCloseBootQueue")},dSGR:function(W,p,r){"use strict";r.d(p,"a",function(){return d});const d="canAccessClientV2"}}]);})();
